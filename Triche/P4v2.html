<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Puissance 4 Alpha-Beta V2</title>
    <style>
        :root { --bg: #010409; --board: #1f6feb; --player: #ff7b72; --bot: #f2cc60; --text: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        /* HEADER & STATS */
        .header { text-align: center; margin-bottom: 20px; width: 100%; max-width: 500px; }
        .ai-chat { min-height: 40px; color: #8b949e; font-style: italic; font-size: 0.9rem; margin: 10px 0; }
        
        .gauge-container { width: 90%; background: #21262d; height: 30px; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #30363d; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #win-bar { width: 50%; height: 100%; background: linear-gradient(90deg, var(--player) 0%, #ab7df8 50%, var(--bot) 100%); transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .gauge-labels { position: absolute; top: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; font-weight: bold; text-shadow: 1px 1px 2px #000; pointer-events: none; }

        /* PLATEAU */
        #game-area { position: relative; padding: 15px; background: var(--board); border-radius: 10px; box-shadow: 0 15px 40px rgba(0,0,0,0.8); }
        #grid { display: grid; grid-template-columns: repeat(7, 60px); grid-template-rows: repeat(6, 60px); gap: 10px; }
        .cell { width: 60px; height: 60px; background: var(--bg); border-radius: 50%; cursor: pointer; position: relative; box-shadow: inset 0 4px 10px rgba(0,0,0,0.9); }
        
        .piece { width: 100%; height: 100%; border-radius: 50%; animation: drop 0.4s cubic-bezier(0.12, 0, 0.39, 0); }
        .p1 { background: radial-gradient(circle at 30% 30%, #ff7b72, #8e1519); box-shadow: 0 0 15px rgba(255,123,114,0.4); }
        .p2 { background: radial-gradient(circle at 30% 30%, #f2cc60, #967300); box-shadow: 0 0 15px rgba(242,204,96,0.4); }

        @keyframes drop { from { transform: translateY(-350px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* CONTROLES */
        .controls { margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        select, button { background: #21262d; color: var(--text); border: 1px solid #30363d; padding: 10px 15px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #30363d; border-color: #8b949e; }
        .win-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; z-index: 10; font-size: 2rem; }
    </style>
</head>
<body>

<div class="header">
    <h1>AI Dominator v2</h1>
    <div id="ai-chat" class="ai-chat">Analyse de la grille...</div>
</div>

<div class="gauge-container">
    <div id="win-bar"></div>
    <div class="gauge-labels">
        <span>MOI</span>
        <span id="pct-label">50%</span>
        <span>BOT</span>
    </div>
</div>

<div id="game-area">
    <div id="grid"></div>
    <div id="win-overlay" class="win-overlay">
        <div id="win-msg">MATCH NUL</div>
        <button onclick="resetGame()" style="margin-top: 20px;">REVANCHE</button>
    </div>
</div>

<div class="controls">
    <select id="diff">
        <option value="4">Niveau : Amateur</option>
        <option value="6" selected>Niveau : Expert</option>
        <option value="8">Niveau : Grand Maître</option>
    </select>
    <select id="starter">
        <option value="1">Je commence</option>
        <option value="2">Le Bot commence</option>
    </select>
    <button onclick="resetGame()">RESET</button>
</div>

<script>
    const ROWS = 6, COLS = 7;
    let board = [], over = false, curPlayer = 1;

    function init() {
        board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
        over = false;
        document.getElementById('grid').innerHTML = '';
        document.getElementById('win-overlay').style.display = 'none';
        
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => { if(curPlayer === 1 && !over) play(c); };
                document.getElementById('grid').appendChild(cell);
            }
        }
        curPlayer = parseInt(document.getElementById('starter').value);
        if (curPlayer === 2) setTimeout(aiPlay, 500);
        updateStats(0);
    }

    function play(col) {
        let r = getOpenRow(board, col);
        if (r === -1) return;
        
        board[r][col] = curPlayer;
        drawPiece(r, col, curPlayer);
        
        if (checkWin(board, curPlayer)) return end(curPlayer);
        if (board[0].every(c => c !== 0)) return end(0);
        
        curPlayer = (curPlayer === 1) ? 2 : 1;
        if (curPlayer === 2) {
            document.getElementById('ai-chat').textContent = "Je réfléchis à ton erreur...";
            setTimeout(aiPlay, 400);
        }
    }

    function aiPlay() {
        if (over) return;
        let depth = parseInt(document.getElementById('diff').value);
        let result = getBestMove(board, depth);
        play(result.col);
        updateStats(result.score);
    }

    /* --- MOTEUR DE CALCUL --- */
    function getBestMove(b, depth) {
        let bestScore = -Infinity, bestCol = 3;
        const order = [3, 2, 4, 1, 5, 0, 6];
        
        for (let c of order) {
            let r = getOpenRow(b, c);
            if (r !== -1) {
                b[r][c] = 2;
                let score = minimax(b, depth - 1, false, -Infinity, Infinity);
                b[r][c] = 0;
                if (score > bestScore) { bestScore = score; bestCol = c; }
            }
        }
        return { col: bestCol, score: bestScore };
    }

    function minimax(n, d, isMax, a, bt) {
        if (checkWin(n, 2)) return 10000 + d;
        if (checkWin(n, 1)) return -10000 - d;
        if (d === 0) return heuristic(n);

        if (isMax) {
            let v = -Infinity;
            for (let c = 0; c < COLS; c++) {
                let r = getOpenRow(n, c);
                if (r !== -1) {
                    n[r][c] = 2; v = Math.max(v, minimax(n, d-1, false, a, bt)); n[r][c] = 0;
                    a = Math.max(a, v); if (bt <= a) break;
                }
            }
            return v;
        } else {
            let v = Infinity;
            for (let c = 0; c < COLS; c++) {
                let r = getOpenRow(n, c);
                if (r !== -1) {
                    n[r][c] = 1; v = Math.min(v, minimax(n, d-1, true, a, bt)); n[r][c] = 0;
                    bt = Math.min(bt, v); if (bt <= a) break;
                }
            }
            return v;
        }
    }

    /* --- NOUVELLE ÉVALUATION RÉALISTE --- */
    function heuristic(b) {
        let score = 0;
        // Poids énorme sur le centre
        for(let r=0; r<ROWS; r++) {
            if(b[r][3] === 2) score += 30;
            if(b[r][3] === 1) score -= 30;
        }

        const evaluateWindow = (w) => {
            let s = 0;
            let b2 = w.filter(v => v === 2).length;
            let b1 = w.filter(v => v === 1).length;
            let empty = w.filter(v => v === 0).length;

            if (b2 === 3 && empty === 1) s += 100;
            if (b2 === 2 && empty === 2) s += 10;
            if (b1 === 3 && empty === 1) s -= 120; // Priorité défense
            if (b1 === 2 && empty === 2) s -= 15;
            return s;
        };

        // Balayage horizontal
        for (let r=0; r<6; r++) for (let c=0; c<4; c++) score += evaluateWindow([b[r][c], b[r][c+1], b[r][c+2], b[r][c+3]]);
        // Balayage vertical
        for (let c=0; c<7; c++) for (let r=0; r<3; r++) score += evaluateWindow([b[r][c], b[r+1][c], b[r+2][c], b[r+3][c]]);
        // Diagonales
        for (let r=0; r<3; r++) for (let c=0; c<4; c++) score += evaluateWindow([b[r][c], b[r+1][c+1], b[r+2][c+2], b[r+3][c+3]]);
        for (let r=0; r<3; r++) for (let c=3; c<7; c++) score += evaluateWindow([b[r][c], b[r+1][c-1], b[r+2][c-2], b[r+3][c-3]]);

        return score;
    }

    function updateStats(score) {
        // Transformation logistique du score pour une barre qui bouge bien
        let winProb = 50 + (score / 15); 
        if (score > 500) winProb = 98; // IA gagne quasiment
        if (score < -500) winProb = 2; // Humain gagne quasiment
        
        winProb = Math.max(5, Math.min(95, winProb));
        
        document.getElementById('win-bar').style.width = winProb + '%';
        document.getElementById('pct-label').textContent = Math.round(100 - winProb) + '%';
        
        // Chat bot selon le score
        const chat = document.getElementById('ai-chat');
        if (winProb > 80) chat.textContent = "Regarde ta barre de vie... C'est fini.";
        else if (winProb > 60) chat.textContent = "Je commence à voir ton futur.";
        else if (winProb < 40) chat.textContent = "Oh ? Tu joues mieux que prévu.";
        else chat.textContent = "Analyse en cours... Tu es prévisible.";
    }

    /* --- UTILITAIRES STANDARDS --- */
    function checkWin(b, p) {
        for (let r=0; r<6; r++) for (let c=0; c<4; c++) if (b[r][c]===p && b[r][c+1]===p && b[r][c+2]===p && b[r][c+3]===p) return true;
        for (let c=0; c<7; c++) for (let r=0; r<3; r++) if (b[r][c]===p && b[r+1][c]===p && b[r+2][c]===p && b[r+3][c]===p) return true;
        for (let r=0; r<3; r++) for (let c=0; c<4; c++) if (b[r][c]===p && b[r+1][c+1]===p && b[r+2][c+2]===p && b[r+3][c+3]===p) return true;
        for (let r=0; r<3; r++) for (let c=3; c<7; c++) if (b[r][c]===p && b[r+1][c-1]===p && b[r+2][c-2]===p && b[r+3][c-3]===p) return true;
        return false;
    }

    function getOpenRow(b, c) { for (let r = 5; r >= 0; r--) if (b[r][c] === 0) return r; return -1; }

    function drawPiece(r, c, p) {
        const cell = document.getElementById('grid').children[r * 7 + c];
        const piece = document.createElement('div');
        piece.className = 'piece ' + (p === 1 ? 'p1' : 'p2');
        cell.appendChild(piece);
    }

    function end(winner) {
        over = true;
        const msg = document.getElementById('win-msg');
        document.getElementById('win-overlay').style.display = 'flex';
        if (winner === 0) msg.textContent = "MATCH NUL";
        else msg.textContent = (winner === 1 ? "INCROYABLE : TU AS GAGNÉ" : "IA DOMINATION");
        updateStats(winner === 2 ? 10000 : -10000);
    }

    function resetGame() { init(); }

    init();
</script>
</body>
</html>
